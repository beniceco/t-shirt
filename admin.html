<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم SOLY HUX - إدارة الطلبات</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Google Font: Cairo -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Estilos CSS aquí -->
    <style>
        :root {
            --primary-color: #4a6de5;
            --secondary-color: #8f94fb;
            --accent-color: #FF6B6B;
            --success-color: #4CAF50;
            --warning-color: #FFC107;
            --danger-color: #F44336;
            --dark-color: #2c3e50;
            --light-color: #f8f9fa;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f5f7ff;
            color: #333;
        }
        
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            border-radius: var(--border-radius);
            background: white;
            box-shadow: var(--box-shadow);
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            text-align: center;
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card i {
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--dark-color);
        }
        
        .filters-container {
            background: white;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
        }
        
        .orders-table {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
        }
        
        .status-pending {
            background-color: var(--warning-color);
            color: white;
        }
        
        .status-processing {
            background-color: var(--primary-color);
            color: white;
        }
        
        .status-shipped {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .status-delivered {
            background-color: var(--success-color);
            color: white;
        }
        
        .status-cancelled {
            background-color: var(--danger-color);
            color: white;
        }
        
        .action-btn {
            padding: 5px 10px;
            border-radius: var(--border-radius);
            margin-right: 5px;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .view-btn {
            background-color: var(--primary-color);
            color: white;
        }
        
        .view-btn:hover {
            background-color: #3a5bd4;
        }
        
        .edit-btn {
            background-color: var(--accent-color);
            color: white;
        }
        
        .edit-btn:hover {
            background-color: #ff5252;
        }
        
        /* Order Modal Styling */
        .order-modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 1000;
        }
        
        .order-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            width: 90%;
            max-width: 800px;
            border-radius: var(--border-radius);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            display: none;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .order-modal-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px 20px;
            border-top-left-radius: var(--border-radius);
            border-top-right-radius: var(--border-radius);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .order-modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .order-modal-body {
            padding: 20px;
        }
        
        .order-info-section {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .product-item {
            display: flex;
            margin-bottom: 15px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: var(--border-radius);
        }
        
        .product-details {
            flex-grow: 1;
        }
        
        .status-update-container {
            background: #f5f5f5;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-top: 20px;
        }
        
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        /* أنماط للطلبات المحلية */
        .local-order-row {
            background-color: #f0f8ff;
        }
        
        .local-order-row:hover {
            background-color: #e6f2ff;
        }
        
        .storage-source-badge {
            font-size: 0.7rem;
            padding: 2px 5px;
            border-radius: 4px;
            margin-right: 5px;
            background-color: #17a2b8;
            color: white;
        }
        
        .dashboard-info-box {
            background-color: #fffde7;
            border-left: 4px solid #ffc107;
            padding: 10px 15px;
            margin-bottom: 15px;
            border-radius: 4px;
        }
        
        .dashboard-info-box p {
            margin-bottom: 0;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .stats-container {
                grid-template-columns: 1fr 1fr;
            }
            
            .table-responsive {
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <!-- Login Container -->
    <div id="loginContainer" class="login-container">
        <h2 class="text-center mb-4">تسجيل دخول المشرف</h2>
        <form id="loginForm">
            <div class="mb-3">
                <label for="adminUsername" class="form-label">اسم المستخدم</label>
                <input type="text" class="form-control" id="adminUsername" required>
            </div>
            <div class="mb-3">
                <label for="adminPassword" class="form-label">كلمة المرور</label>
                <input type="password" class="form-control" id="adminPassword" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">تسجيل الدخول</button>
        </form>
    </div>

    <!-- Dashboard Container -->
    <div id="dashboardContainer" class="admin-container" style="display: none;">
        <div class="dashboard-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-tshirt me-2"></i> لوحة تحكم SOLY HUX</h1>
                    <p class="mb-0">مرحبًا بك في لوحة التحكم لإدارة طلبات SOLY HUX</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <button onclick="logoutAdmin()" class="btn btn-light">
                        <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
                    </button>
                </div>
            </div>
        </div>

        <!-- Statistics -->
        <div class="stats-container">
            <div class="stat-card">
                <i class="fas fa-shopping-cart"></i>
                <div class="stat-title">إجمالي الطلبات</div>
                <div class="stat-value" id="totalOrders">0</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-clock"></i>
                <div class="stat-title">قيد الانتظار</div>
                <div class="stat-value" id="pendingOrders">0</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-box"></i>
                <div class="stat-title">جاري التجهيز</div>
                <div class="stat-value" id="processingOrders">0</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-check-circle"></i>
                <div class="stat-title">تم التوصيل</div>
                <div class="stat-value" id="deliveredOrders">0</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-money-bill-wave"></i>
                <div class="stat-title">إجمالي الإيرادات</div>
                <div class="stat-value" id="totalRevenue">0 ج.م</div>
            </div>
        </div>

        <!-- صندوق معلومات لتوضيح مصدر الطلبات المحلية -->
        <div class="dashboard-info-box">
            <p><i class="fas fa-info-circle"></i> <strong>ملاحظة:</strong> الطلبات المميزة بعلامة <span class="badge bg-info">محلي</span> تم استلامها وتخزينها محليًا عندما كان الموقع يعمل دون اتصال بالإنترنت أو في حالة تعذر الاتصال بخدمات التخزين السحابي.</p>
        </div>

        <!-- Filters -->
        <div class="filters-container">
            <div class="row g-2 align-items-center">
                <div class="col-md-6">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-primary filter-btn active" data-filter="all">الكل</button>
                        <button type="button" class="btn btn-outline-primary filter-btn" data-filter="pending">قيد الانتظار</button>
                        <button type="button" class="btn btn-outline-primary filter-btn" data-filter="processing">جاري التجهيز</button>
                        <button type="button" class="btn btn-outline-primary filter-btn" data-filter="shipped">تم الشحن</button>
                        <button type="button" class="btn btn-outline-primary filter-btn" data-filter="delivered">تم التوصيل</button>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" id="searchInput" placeholder="البحث عن طلب (رقم الطلب، اسم العميل، رقم الهاتف)">
                    </div>
                </div>
            </div>
            
            <!-- Botones de exportación -->
            <div class="row mt-3">
                <div class="col-12 text-end">
                    <button id="exportCSVBtn" class="btn btn-success">
                        <i class="fas fa-file-csv"></i> تنزيل كملف CSV
                    </button>
                </div>
            </div>
        </div>

        <!-- Orders Table -->
        <div class="orders-table">
            <table class="table table-hover" id="ordersTable">
                <thead class="table-light">
                    <tr>
                        <th>رقم الطلب</th>
                        <th>اسم العميل</th>
                        <th>رقم الهاتف</th>
                        <th>تاريخ الطلب</th>
                        <th>عدد المنتجات</th>
                        <th>المبلغ الإجمالي</th>
                        <th>الحالة</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody id="ordersTableBody">
                    <!-- Table rows will be added dynamically -->
                </tbody>
            </table>
            
            <!-- Empty State -->
            <div id="emptyState" class="empty-state" style="display: none;">
                <i class="fas fa-shopping-bag"></i>
                <h4>لا توجد طلبات</h4>
                <p>لم يتم العثور على أي طلبات في النظام حاليًا.</p>
            </div>
        </div>
    </div>

    <!-- Order Modal -->
    <div id="orderModalBackdrop" class="order-modal-backdrop"></div>
    <div id="orderModal" class="order-modal">
        <div class="order-modal-header">
            <h3>تفاصيل الطلب <span id="orderDetailId"></span></h3>
            <button id="orderModalClose" class="order-modal-close">&times;</button>
        </div>
        <div class="order-modal-body">
            <div class="row order-info-section">
                <div class="col-md-6">
                    <h5>معلومات الطلب</h5>
                    <p><strong>رقم الطلب:</strong> <span id="orderDetailId"></span></p>
                    <p><strong>تاريخ الطلب:</strong> <span id="orderDetailDate"></span></p>
                    <p><strong>الحالة الحالية:</strong> <span id="currentStatus" class="status-badge"></span></p>
                </div>
                <div class="col-md-6">
                    <h5>معلومات العميل</h5>
                    <p><strong>الاسم:</strong> <span id="customerName"></span></p>
                    <p><strong>رقم الهاتف:</strong> <span id="customerPhone"></span></p>
                    <p><strong>العنوان:</strong> <span id="customerAddress"></span></p>
                    <p><strong>ملاحظات:</strong> <span id="orderNotes"></span></p>
                </div>
            </div>

            <div class="order-info-section">
                <h5>المنتجات</h5>
                <div id="productsContainer">
                    <!-- Product details will be added dynamically -->
                </div>
                
                <div class="mt-3">
                    <p><strong>المبلغ الإجمالي:</strong> <span id="orderTotal"></span></p>
                </div>
            </div>

            <div class="status-update-container">
                <h5>تحديث حالة الطلب</h5>
                <div class="row g-2">
                    <div class="col-md-8">
                        <select id="statusUpdateSelect" class="form-select">
                            <option value="pending">قيد الانتظار</option>
                            <option value="processing">جاري التجهيز</option>
                            <option value="shipped">تم الشحن</option>
                            <option value="delivered">تم التوصيل</option>
                            <option value="cancelled">ملغي</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <button id="updateStatusBtn" class="btn btn-primary w-100" data-order-id="">تحديث الحالة</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Order Modal -->
    <div id="editOrderModalBackdrop" class="order-modal-backdrop"></div>
    <div id="editOrderModal" class="order-modal">
        <div class="order-modal-header">
            <h3>تعديل الطلب <span id="editOrderDetailId"></span></h3>
            <button id="editOrderModalClose" class="order-modal-close">&times;</button>
        </div>
        <div class="order-modal-body">
            <form id="editOrderForm">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h5>معلومات الطلب</h5>
                        <p><strong>رقم الطلب:</strong> <span id="editOrderNumber"></span></p>
                        <p><strong>تاريخ الطلب:</strong> <span id="editOrderDate"></span></p>
                        
                        <div class="mb-3">
                            <label for="editOrderStatus" class="form-label">الحالة</label>
                            <select id="editOrderStatus" class="form-select">
                                <option value="pending">قيد الانتظار</option>
                                <option value="processing">جاري التجهيز</option>
                                <option value="shipped">تم الشحن</option>
                                <option value="delivered">تم التوصيل</option>
                                <option value="cancelled">ملغي</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <h5>معلومات العميل</h5>
                        <div class="mb-3">
                            <label for="editCustomerName" class="form-label">الاسم</label>
                            <input type="text" class="form-control" id="editCustomerName">
                        </div>
                        
                        <div class="mb-3">
                            <label for="editCustomerPhone" class="form-label">رقم الهاتف الأساسي</label>
                            <input type="text" class="form-control" id="editCustomerPhone">
                        </div>
                        
                        <div class="mb-3">
                            <label for="editCustomerPhone2" class="form-label">رقم الهاتف البديل (اختياري)</label>
                            <input type="text" class="form-control" id="editCustomerPhone2">
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="editCustomerAddress" class="form-label">العنوان</label>
                    <textarea class="form-control" id="editCustomerAddress" rows="3"></textarea>
                </div>
                
                <div class="mb-3">
                    <label for="editOrderNotes" class="form-label">ملاحظات</label>
                    <textarea class="form-control" id="editOrderNotes" rows="3"></textarea>
                </div>
                
                <div class="mb-4">
                    <h5>المنتجات</h5>
                    <div id="editProductsContainer">
                        <!-- Product edit fields will be added dynamically -->
                    </div>
                </div>
                
                <div class="text-end">
                    <button type="button" class="btn btn-secondary me-2" id="cancelEditBtn">إلغاء</button>
                    <button type="submit" class="btn btn-primary" id="saveChangesBtn">
                        <i class="fas fa-save"></i> حفظ التغييرات
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Google Sheet Sync Modal -->
    <!-- تم حذف هذا القسم بالكامل -->

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Admin JS -->
    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDXoL55fWEJHYEYBgNxcKYKB9Tr2bNkAFk",
            authDomain: "summer-tshirt-orders.firebaseapp.com",
            databaseURL: "https://summer-tshirt-orders-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "summer-tshirt-orders",
            storageBucket: "summer-tshirt-orders.appspot.com",
            messagingSenderId: "1007990647992",
            appId: "1:1007990647992:web:13a7c3f70dd84d88ad139b",
            measurementId: "G-4GL1ZK2JE4"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Variables globales
        let allOrders = [];
        let currentFilter = 'all';
        let adminLoggedIn = false;

        // Elementos DOM
        const loginForm = document.getElementById('loginForm');
        const loginContainer = document.getElementById('loginContainer');
        const dashboardContainer = document.getElementById('dashboardContainer');
        const ordersTableBody = document.getElementById('ordersTableBody');
        const filterButtons = document.querySelectorAll('.filter-btn');
        const searchInput = document.getElementById('searchInput');
        const orderModal = document.getElementById('orderModal');
        const orderModalBackdrop = document.getElementById('orderModalBackdrop');
        const statusUpdateSelect = document.getElementById('statusUpdateSelect');
        const updateStatusBtn = document.getElementById('updateStatusBtn');
        const orderModalClose = document.getElementById('orderModalClose');
        const emptyStateElement = document.getElementById('emptyState');

        // Estadísticas
        const totalOrdersElement = document.getElementById('totalOrders');
        const pendingOrdersElement = document.getElementById('pendingOrders');
        const processingOrdersElement = document.getElementById('processingOrders');
        const deliveredOrdersElement = document.getElementById('deliveredOrders');
        const totalRevenueElement = document.getElementById('totalRevenue');

        // Inicialización cuando se carga el DOM
        document.addEventListener('DOMContentLoaded', () => {
            // Eliminar cualquier configuración guardada de SheetDB.io
            localStorage.removeItem('gsheetSettings');
            
            // Comprobar si hay una sesión activa
            checkAdminSession();
            
            // Event listeners
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
            
            filterButtons.forEach(button => {
                button.addEventListener('click', () => {
                    currentFilter = button.dataset.filter;
                    filterOrders(currentFilter);
                    updateActiveFilterButton(button);
                });
            });
            
            if (searchInput) {
                searchInput.addEventListener('input', handleSearch);
            }
            
            if (orderModalClose) {
                orderModalClose.addEventListener('click', closeOrderModal);
            }
            
            if (orderModalBackdrop) {
                orderModalBackdrop.addEventListener('click', closeOrderModal);
            }
            
            if (updateStatusBtn) {
                updateStatusBtn.addEventListener('click', updateOrderStatus);
            }
            
            // Event listeners para exportación y sincronización
            const exportCSVBtn = document.getElementById('exportCSVBtn');
            
            if (exportCSVBtn) {
                exportCSVBtn.addEventListener('click', exportOrdersToCSV);
            }
        });

        // Verificar si hay una sesión de administrador activa
        function checkAdminSession() {
            const adminSession = localStorage.getItem('adminSession');
            
            if (adminSession === 'active') {
                adminLoggedIn = true;
                showDashboard();
                setupRealtimeListener();
            } else {
                showLoginForm();
            }
        }

        // Manejar el inicio de sesión
        function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            
            // Credenciales simplificadas para este ejemplo
            // En un sistema real, usar autenticación de Firebase
            if (username === 'admin' && password === 'Soly2025!') {
                adminLoggedIn = true;
                localStorage.setItem('adminSession', 'active');
                showDashboard();
                setupRealtimeListener();
            } else {
                alert('اسم المستخدم أو كلمة المرور غير صحيحة');
            }
        }

        // Mostrar formulario de inicio de sesión
        function showLoginForm() {
            loginContainer.style.display = 'block';
            dashboardContainer.style.display = 'none';
        }

        // Mostrar panel principal
        function showDashboard() {
            loginContainer.style.display = 'none';
            dashboardContainer.style.display = 'block';
        }

        // Cerrar sesión
        function logoutAdmin() {
            adminLoggedIn = false;
            localStorage.removeItem('adminSession');
            showLoginForm();
        }

        // إعداد المستمع الفوري للطلبات من Firebase
        function setupRealtimeListener() {
            if (!adminLoggedIn) return;

            // الاستماع للتغييرات في مجموعة 'orders'، مرتبة حسب الطابع الزمني تنازلياً
            db.collection('orders').orderBy('timestamp', 'desc')
              .onSnapshot(snapshot => {
                    console.log("Firestore snapshot received");
                    allOrders = [];
                    snapshot.forEach(doc => {
                        allOrders.push({
                            id: doc.id,
                            ...doc.data(),
                            source: 'firestore'
                        });
                    });
                    
                    // دمج الطلبات المحلية (إذا كان لا يزال مطلوبًا)
                    fetchLocalStorageOrders(); 
                    
                    updateStatistics();
                    filterOrders(currentFilter);

                    console.log(`Total orders after snapshot update: ${allOrders.length}`);

                }, error => {
                    console.error("Error fetching real-time orders: ", error);
                    allOrders = [];
                    fetchLocalStorageOrders(); 
                    updateStatistics();
                    filterOrders(currentFilter);
                    showErrorState("حدث خطأ أثناء الاتصال بقاعدة البيانات لتحديث الطلبات.");
                });
        }
        
        // جلب الطلبات من localStorage (تعديل طفيف للتكامل مع المستمع)
        function fetchLocalStorageOrders() {
            try {
                const localOrdersData = JSON.parse(localStorage.getItem('adminDashboardOrders') || '[]');
                
                if (localOrdersData.length > 0) {
                    localOrdersData.forEach(localOrder => {
                        // التحقق مما إذا كان الطلب موجودًا بالفعل من Firestore (لتجنب التكرار)
                        const existingFirestoreOrderIndex = allOrders.findIndex(o => o.order_number === localOrder.order_number && o.source === 'firestore');
                        
                        if (existingFirestoreOrderIndex === -1) {
                           // التحقق مما إذا كان الطلب المحلي موجودًا بالفعل في allOrders
                           const existingLocalOrderIndex = allOrders.findIndex(o => o.order_number === localOrder.order_number && o.source === 'local_storage');
                           
                           if (existingLocalOrderIndex === -1) {
                               // إضافة الطلب المحلي فقط إذا لم يكن موجودًا من Firestore أو محليًا
                                allOrders.push({
                                    id: `local_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`, 
                                    ...localOrder,
                                    source: 'local_storage' 
                                });
                           }
                        }
                    });
                     console.log(`Added ${localOrdersData.length} potential local orders. Total orders now: ${allOrders.length}`);
                }
            } catch (error) {
                console.error("Error fetching orders from localStorage:", error);
            }
        }
        
        // تحديث البيانات المحلية عند تغيير حالة الطلب
        function updateOrderStatus() {
            const orderId = updateStatusBtn.dataset.orderId;
            const newStatus = statusUpdateSelect.value;
            
            if (!orderId) {
                alert('لم يتم تحديد طلب للتحديث');
                return;
            }
            
            updateStatusBtn.disabled = true;
            updateStatusBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التحديث...';
            
            // التحقق مما إذا كان الطلب محليًا
            const order = allOrders.find(o => o.id === orderId);
            if (order && order.source === 'local_storage') {
                // تحديث الطلب في localStorage
                updateLocalStorageOrder(orderId, { status: newStatus });
                
                // تحديث واجهة المستخدم
                updateOrderInLocalArray(orderId, newStatus);
                
                alert('تم تحديث حالة الطلب بنجاح');
                closeOrderModal();
                filterOrders(currentFilter);
                updateStatistics();
                
                updateStatusBtn.disabled = false;
                updateStatusBtn.innerHTML = 'تحديث الحالة';
                return;
            }
            
            // استمر مع تحديث Firebase كالمعتاد
            db.collection('orders').doc(orderId).update({
                status: newStatus
            })
            .then(() => {
                // Actualizar también en la colección diaria si existe
                if (order.order_date) {
                    const orderDate = new Date(order.order_date);
                    const dateString = orderDate.toISOString().split('T')[0];
                    
                    db.collection('orders_by_date').doc(dateString).collection('daily_orders').doc(orderId)
                        .update({ status: newStatus })
                        .catch(error => console.error("Error updating daily order:", error));
                }
                
                // Actualizar UI
                updateOrderInLocalArray(orderId, newStatus);
                
                alert('تم تحديث حالة الطلب بنجاح');
                closeOrderModal();
                filterOrders(currentFilter);
                updateStatistics();
            })
            .catch(error => {
                console.error("Error updating order status:", error);
                alert('حدث خطأ أثناء تحديث حالة الطلب');
            })
            .finally(() => {
                updateStatusBtn.disabled = false;
                updateStatusBtn.innerHTML = 'تحديث الحالة';
            });
        }
        
        // تحديث طلب في localStorage
        function updateLocalStorageOrder(orderId, newData) {
            try {
                const localOrders = JSON.parse(localStorage.getItem('adminDashboardOrders') || '[]');
                const orderIndex = localOrders.findIndex(order => 
                    `local_${Date.now()}_${Math.random().toString(36).substr(2, 9)}` === orderId || 
                    order.order_number === allOrders.find(o => o.id === orderId)?.order_number
                );
                
                if (orderIndex !== -1) {
                    localOrders[orderIndex] = {
                        ...localOrders[orderIndex],
                        ...newData
                    };
                    
                    localStorage.setItem('adminDashboardOrders', JSON.stringify(localOrders));
                }
            } catch (error) {
                console.error("Error updating local storage order:", error);
            }
        }

        // Actualizar estadísticas
        function updateStatistics() {
            if (allOrders.length === 0) {
                totalOrdersElement.textContent = '0';
                pendingOrdersElement.textContent = '0';
                processingOrdersElement.textContent = '0';
                deliveredOrdersElement.textContent = '0';
                totalRevenueElement.textContent = '0 ج.م';
                return;
            }
            
            const pendingCount = allOrders.filter(order => order.status === 'pending').length;
            const processingCount = allOrders.filter(order => order.status === 'processing').length;
            const deliveredCount = allOrders.filter(order => order.status === 'delivered').length;
            
            // Calcular ingresos totales
            let totalRevenue = 0;
            allOrders.forEach(order => {
                const priceStr = order.total_price;
                if (priceStr) {
                    // Extraer solo los números del formato "XXX ج.م"
                    const price = parseInt(priceStr.replace(/[^\d]/g, ''));
                    if (!isNaN(price)) {
                        totalRevenue += price;
                    }
                }
            });
            
            totalOrdersElement.textContent = allOrders.length;
            pendingOrdersElement.textContent = pendingCount;
            processingOrdersElement.textContent = processingCount;
            deliveredOrdersElement.textContent = deliveredCount;
            totalRevenueElement.textContent = `${totalRevenue} ج.م`;
        }

        // عرض الطلبات الموجودة محليًا بشكل مختلف
        function displayOrders(orders) {
            if (orders.length === 0) {
                showEmptyState();
                return;
            }
            
            hideEmptyState();
            ordersTableBody.innerHTML = '';
            
            orders.forEach(order => {
                const statusClass = `status-${order.status || 'pending'}`;
                const statusText = getStatusText(order.status || 'pending');
                const isLocalOrder = order.source === 'local_storage';
                
                const row = document.createElement('tr');
                // إضافة فئة خاصة للطلبات المحلية
                if (isLocalOrder) {
                    row.classList.add('local-order-row');
                }
                
                row.innerHTML = `
                    <td>${order.order_number} ${isLocalOrder ? '<span class="badge bg-info">محلي</span>' : ''}</td>
                    <td>${order.customer_name}</td>
                    <td>${order.customer_mobile}</td>
                    <td>${formatDate(order.order_date)}</td>
                    <td>${order.total_items || '-'}</td>
                    <td>${order.total_price || '-'}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>
                        <button class="action-btn view-btn" onclick="viewOrderDetails('${order.id}')">
                            <i class="fas fa-eye"></i> عرض
                        </button>
                        <button class="action-btn edit-btn" onclick="editOrderDetails('${order.id}')">
                            <i class="fas fa-edit"></i> تعديل
                        </button>
                    </td>
                `;
                
                ordersTableBody.appendChild(row);
            });
        }

        // Filtrar pedidos por estado
        function filterOrders(filter) {
            let filteredOrders;
            
            if (filter === 'all') {
                filteredOrders = allOrders;
            } else {
                filteredOrders = allOrders.filter(order => order.status === filter);
            }
            
            displayOrders(filteredOrders);
        }

        // Buscar pedidos
        function handleSearch() {
            const searchTerm = searchInput.value.toLowerCase();
            
            if (searchTerm.trim() === '') {
                filterOrders(currentFilter);
                return;
            }
            
            let searchResults = allOrders.filter(order => {
                return (
                    order.order_number.toLowerCase().includes(searchTerm) ||
                    order.customer_name.toLowerCase().includes(searchTerm) ||
                    order.customer_mobile.includes(searchTerm)
                );
            });
            
            if (currentFilter !== 'all') {
                searchResults = searchResults.filter(order => order.status === currentFilter);
            }
            
            displayOrders(searchResults);
        }

        // Mostrar detalles de un pedido
        function viewOrderDetails(orderId) {
            const order = allOrders.find(order => order.id === orderId);
            
            if (!order) {
                alert('لم يتم العثور على الطلب');
                return;
            }
            
            // Elementos del modal
            const orderIdElement = document.getElementById('orderDetailId');
            const orderDateElement = document.getElementById('orderDetailDate');
            const customerNameElement = document.getElementById('customerName');
            const customerPhoneElement = document.getElementById('customerPhone');
            const customerAddressElement = document.getElementById('customerAddress');
            const orderNotesElement = document.getElementById('orderNotes');
            const productsContainerElement = document.getElementById('productsContainer');
            const orderTotalElement = document.getElementById('orderTotal');
            const currentStatusElement = document.getElementById('currentStatus');
            
            // Rellenar los datos del pedido
            orderIdElement.textContent = order.order_number;
            orderDateElement.textContent = formatDate(order.order_date);
            customerNameElement.textContent = order.customer_name;
            customerPhoneElement.textContent = order.customer_mobile;
            customerAddressElement.textContent = order.customer_address;
            orderNotesElement.textContent = order.order_notes || 'لا توجد ملاحظات';
            orderTotalElement.textContent = order.total_price;
            
            // Establecer estado actual
            currentStatusElement.textContent = getStatusText(order.status || 'pending');
            currentStatusElement.className = `status-badge status-${order.status || 'pending'}`;
            
            // Seleccionar el estado actual en el dropdown
            statusUpdateSelect.value = order.status || 'pending';
            
            // Establecer el ID del pedido para la actualización
            updateStatusBtn.dataset.orderId = order.id;
            
            // Mostrar los productos
            productsContainerElement.innerHTML = '';
            
            try {
                const products = JSON.parse(order.product_details);
                
                if (products && products.length > 0) {
                    products.forEach(product => {
                        const productElement = document.createElement('div');
                        productElement.className = 'product-item';
                        
                        productElement.innerHTML = `
                            <div class="product-details">
                                <p><strong>اللون:</strong> ${getColorName(product.color)}</p>
                                <p><strong>المقاس:</strong> ${product.size}</p>
                                <p><strong>الكمية:</strong> ${product.quantity}</p>
                            </div>
                        `;
                        
                        productsContainerElement.appendChild(productElement);
                    });
                } else {
                    productsContainerElement.innerHTML = '<p class="text-muted">لا توجد تفاصيل للمنتجات</p>';
                }
            } catch (e) {
                console.error("Error parsing product details:", e);
                productsContainerElement.innerHTML = '<p class="text-danger">خطأ في عرض تفاصيل المنتجات</p>';
            }
            
            // Mostrar el modal
            orderModalBackdrop.style.display = 'block';
            orderModal.style.display = 'block';
        }

        // Actualizar un pedido en el array local
        function updateOrderInLocalArray(orderId, newStatus) {
            const orderIndex = allOrders.findIndex(order => order.id === orderId);
            
            if (orderIndex !== -1) {
                allOrders[orderIndex].status = newStatus;
            }
        }

        // Cerrar el modal de detalles del pedido
        function closeOrderModal() {
            orderModalBackdrop.style.display = 'none';
            orderModal.style.display = 'none';
        }

        // Actualizar el botón de filtro activo
        function updateActiveFilterButton(activeButton) {
            filterButtons.forEach(button => {
                button.classList.remove('active');
            });
            
            activeButton.classList.add('active');
        }

        // Mostrar estado vacío
        function showEmptyState() {
            emptyStateElement.style.display = 'block';
            document.getElementById('ordersTable').style.display = 'none';
        }

        // Ocultar estado vacío
        function hideEmptyState() {
            emptyStateElement.style.display = 'none';
            document.getElementById('ordersTable').style.display = 'table';
        }

        // Mostrar estado de error
        function showErrorState(message) {
            emptyStateElement.style.display = 'block';
            emptyStateElement.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                <h5>خطأ</h5>
                <p>${message}</p>
            `;
            document.getElementById('ordersTable').style.display = 'none';
        }

        // Formatear fecha
        function formatDate(dateString) {
            if (!dateString) return '-';
            
            const date = new Date(dateString);
            
            if (isNaN(date.getTime())) {
                return dateString;
            }
            
            return date.toLocaleDateString('ar-EG', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Obtener el nombre del color en árabe
        function getColorName(color) {
            const colorNames = {
                'black': 'أسود',
                'white': 'أبيض',
                'silver': 'فضي'
            };
            
            return colorNames[color] || color;
        }

        // Obtener texto de estado en árabe
        function getStatusText(status) {
            const statusTexts = {
                'pending': 'قيد الانتظار',
                'processing': 'جاري التجهيز',
                'shipped': 'تم الشحن',
                'delivered': 'تم التوصيل',
                'cancelled': 'ملغي'
            };
            
            return statusTexts[status] || status;
        }

        // Editar detalles del pedido
        function editOrderDetails(orderId) {
            const order = allOrders.find(order => order.id === orderId);
            
            if (!order) {
                alert('لم يتم العثور على الطلب');
                return;
            }
            
            // Elementos del modal de edición
            const orderNumberElement = document.getElementById('editOrderNumber');
            const orderDateElement = document.getElementById('editOrderDate');
            const orderStatusSelect = document.getElementById('editOrderStatus');
            const customerNameInput = document.getElementById('editCustomerName');
            const customerPhoneInput = document.getElementById('editCustomerPhone');
            const customerPhone2Input = document.getElementById('editCustomerPhone2');
            const customerAddressInput = document.getElementById('editCustomerAddress');
            const orderNotesInput = document.getElementById('editOrderNotes');
            const editProductsContainerElement = document.getElementById('editProductsContainer');
            const saveChangesBtn = document.getElementById('saveChangesBtn');
            
            // Rellenar los datos del pedido en el formulario
            orderNumberElement.textContent = order.order_number;
            orderDateElement.textContent = formatDate(order.order_date);
            orderStatusSelect.value = order.status || 'pending';
            customerNameInput.value = order.customer_name || '';
            customerPhoneInput.value = order.customer_mobile || '';
            customerPhone2Input.value = order.customer_mobile2 || '';
            customerAddressInput.value = order.customer_address || '';
            orderNotesInput.value = order.order_notes || '';
            
            // Guardar el ID del pedido para usarlo al guardar
            saveChangesBtn.dataset.orderId = order.id;
            
            // Mostrar los productos editables
            editProductsContainerElement.innerHTML = '';
            
            try {
                const products = JSON.parse(order.product_details);
                
                if (products && products.length > 0) {
                    products.forEach((product, index) => {
                        const productElement = document.createElement('div');
                        productElement.className = 'edit-product-item card mb-3 p-3';
                        productElement.dataset.productIndex = index;
                        
                        productElement.innerHTML = `
                            <h6>منتج #${index + 1}</h6>
                            <div class="row mb-2">
                                <div class="col-md-4">
                                    <label class="form-label">اللون</label>
                                    <select class="form-select edit-product-color" data-index="${index}">
                                        <option value="black" ${product.color === 'black' ? 'selected' : ''}>أسود</option>
                                        <option value="white" ${product.color === 'white' ? 'selected' : ''}>أبيض</option>
                                        <option value="silver" ${product.color === 'silver' ? 'selected' : ''}>فضي</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">المقاس</label>
                                    <select class="form-select edit-product-size" data-index="${index}">
                                        <option value="S" ${product.size === 'S' ? 'selected' : ''}>S</option>
                                        <option value="M" ${product.size === 'M' ? 'selected' : ''}>M</option>
                                        <option value="L" ${product.size === 'L' ? 'selected' : ''}>L</option>
                                        <option value="XL" ${product.size === 'XL' ? 'selected' : ''}>XL</option>
                                        <option value="XXL" ${product.size === 'XXL' ? 'selected' : ''}>XXL</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">الكمية</label>
                                    <input type="number" class="form-control edit-product-quantity" data-index="${index}" min="1" value="${product.quantity}">
                                </div>
                            </div>
                        `;
                        
                        editProductsContainerElement.appendChild(productElement);
                    });
                } else {
                    editProductsContainerElement.innerHTML = '<p class="text-muted">لا توجد تفاصيل للمنتجات</p>';
                }
            } catch (e) {
                console.error("Error parsing product details:", e);
                editProductsContainerElement.innerHTML = '<p class="text-danger">خطأ في عرض تفاصيل المنتجات</p>';
            }
            
            // Mostrar el modal de edición
            document.getElementById('editOrderModalBackdrop').style.display = 'block';
            document.getElementById('editOrderModal').style.display = 'block';
        }

        // Guardar cambios en el pedido
        function saveOrderChanges(orderId) {
            const order = allOrders.find(order => order.id === orderId);
            
            if (!order) {
                alert('لم يتم العثور على الطلب');
                return;
            }
            
            // Obtener los valores actualizados
            const newStatus = document.getElementById('editOrderStatus').value;
            const newName = document.getElementById('editCustomerName').value;
            const newPhone = document.getElementById('editCustomerPhone').value;
            const newPhone2 = document.getElementById('editCustomerPhone2').value;
            const newAddress = document.getElementById('editCustomerAddress').value;
            const newNotes = document.getElementById('editOrderNotes').value;
            
            // Validar campos obligatorios
            if (!newName || !newPhone || !newAddress) {
                alert('الرجاء ملء جميع الحقول المطلوبة');
                return;
            }
            
            // Obtener productos actualizados
            let updatedProducts = [];
            try {
                const products = JSON.parse(order.product_details || '[]');
                
                if (products && products.length > 0) {
                    products.forEach((_, index) => {
                        const colorSelect = document.querySelector(`.edit-product-color[data-index="${index}"]`);
                        const sizeSelect = document.querySelector(`.edit-product-size[data-index="${index}"]`);
                        const quantityInput = document.querySelector(`.edit-product-quantity[data-index="${index}"]`);
                        
                        if (colorSelect && sizeSelect && quantityInput) {
                            updatedProducts.push({
                                color: colorSelect.value,
                                size: sizeSelect.value,
                                quantity: parseInt(quantityInput.value, 10) || 1
                            });
                        }
                    });
                }
            } catch (e) {
                console.error("Error updating products:", e);
                alert('حدث خطأ أثناء تحديث بيانات المنتجات');
                return;
            }
            
            // Calcular el número total de artículos
            const totalItems = updatedProducts.reduce((total, product) => total + product.quantity, 0);
            
            // Mostrar indicador de carga
            const saveButton = document.getElementById('saveChangesBtn');
            saveButton.disabled = true;
            saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الحفظ...';
            
            // Crear los datos actualizados
            const updatedOrderData = {
                status: newStatus,
                customer_name: newName,
                customer_mobile: newPhone,
                customer_mobile2: newPhone2,
                customer_address: newAddress,
                order_notes: newNotes,
                product_details: JSON.stringify(updatedProducts),
                total_items: totalItems
            };
            
            // التحقق ما إذا كان الطلب من LocalStorage
            if (order.source === 'local_storage') {
                // تحديث الطلب في localStorage
                updateLocalStorageOrder(orderId, updatedOrderData);
                
                // تحديث واجهة المستخدم
                updateOrderInLocalArray(orderId, newStatus, updatedOrderData);
                
                alert('تم تحديث بيانات الطلب بنجاح');
                closeEditOrderModal();
                filterOrders(currentFilter);
                updateStatistics();
                
                // إعادة تمكين زر الحفظ
                saveButton.disabled = false;
                saveButton.innerHTML = '<i class="fas fa-save"></i> حفظ التغييرات';
                return;
            }
            
            // استمر مع تحديث Firebase كالمعتاد
            db.collection('orders').doc(orderId).update(updatedOrderData)
            .then(() => {
                // Actualizar también en la colección diaria si existe
                if (order.order_date) {
                    const orderDate = new Date(order.order_date);
                    const dateString = orderDate.toISOString().split('T')[0];
                    
                    db.collection('orders_by_date').doc(dateString).collection('daily_orders').doc(orderId)
                        .update(updatedOrderData)
                        .catch(error => console.error("Error updating daily order:", error));
                }
                
                // Actualizar UI
                updateOrderInLocalArray(orderId, newStatus, updatedOrderData);
                
                alert('تم تحديث بيانات الطلب بنجاح');
                closeEditOrderModal();
                filterOrders(currentFilter);
                updateStatistics();
            })
            .catch(error => {
                console.error("Error updating order:", error);
                alert('حدث خطأ أثناء تحديث بيانات الطلب');
            })
            .finally(() => {
                saveButton.disabled = false;
                saveButton.innerHTML = '<i class="fas fa-save"></i> حفظ التغييرات';
            });
        }

        // Cerrar el modal de edición
        function closeEditOrderModal() {
            document.getElementById('editOrderModalBackdrop').style.display = 'none';
            document.getElementById('editOrderModal').style.display = 'none';
        }

        // Actualizar un pedido en el array local con todos los datos
        function updateOrderInLocalArray(orderId, newStatus, updatedData) {
            const orderIndex = allOrders.findIndex(order => order.id === orderId);
            
            if (orderIndex !== -1) {
                allOrders[orderIndex] = {
                    ...allOrders[orderIndex],
                    ...updatedData
                };
            }
        }

        // Agregar event listeners para el modal de edición
        document.addEventListener('DOMContentLoaded', () => {
            // ... existing event listeners ...
            
            const editOrderForm = document.getElementById('editOrderForm');
            const editOrderModalClose = document.getElementById('editOrderModalClose');
            const editOrderModalBackdrop = document.getElementById('editOrderModalBackdrop');
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            
            if (editOrderForm) {
                editOrderForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const orderId = document.getElementById('saveChangesBtn').dataset.orderId;
                    saveOrderChanges(orderId);
                });
            }
            
            if (editOrderModalClose) {
                editOrderModalClose.addEventListener('click', closeEditOrderModal);
            }
            
            if (editOrderModalBackdrop) {
                editOrderModalBackdrop.addEventListener('click', closeEditOrderModal);
            }
            
            if (cancelEditBtn) {
                cancelEditBtn.addEventListener('click', closeEditOrderModal);
            }
        });

        // Mantener solo la función de exportación CSV
        function exportOrdersToCSV() {
            // Determinar qué pedidos exportar (filtrados o todos)
            const ordersToExport = currentFilter === 'all' ? allOrders : allOrders.filter(order => order.status === currentFilter);
            
            if (ordersToExport.length === 0) {
                alert('لا توجد طلبات للتصدير');
                return;
            }
            
            // Encabezados del CSV
            const headers = [
                'رقم الطلب',
                'تاريخ الطلب',
                'اسم العميل',
                'رقم الهاتف الرئيسي',
                'رقم الهاتف البديل',
                'العنوان',
                'عدد المنتجات',
                'المبلغ الإجمالي',
                'الحالة',
                'المنتجات',
                'ملاحظات'
            ];
            
            // Convertir pedidos a filas CSV
            const rows = ordersToExport.map(order => {
                // Formatear productos
                let productsInfo = '';
                try {
                    const products = JSON.parse(order.product_details || '[]');
                    productsInfo = products.map(p => `${getColorName(p.color)} - ${p.size} (${p.quantity})`).join(' | ');
                } catch (e) {
                    productsInfo = 'خطأ في البيانات';
                }
                
                return [
                    order.order_number || '',
                    formatDate(order.order_date) || '',
                    order.customer_name || '',
                    order.customer_mobile || '',
                    order.customer_mobile2 || '',
                    order.customer_address || '',
                    order.total_items || '0',
                    order.total_price || '0',
                    getStatusText(order.status || 'pending'),
                    productsInfo,
                    order.order_notes || ''
                ];
            });
            
            // Combinamos encabezados y filas
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
            ].join('\n');
            
            // Crear blob y descargar
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `SOLY_HUX_Orders_${new Date().toISOString().slice(0, 10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html> 